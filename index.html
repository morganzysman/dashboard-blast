<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlaClick Multi-Account Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Authentication Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .auth-title {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .auth-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .pin-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.2em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .pin-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .pin-input.error {
            border-color: #e74c3c;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .logout-btn:hover {
            background: #e74c3c;
            transform: translateY(-2px);
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            display: none; /* Hidden by default until authenticated */
        }
        
        .dashboard.authenticated {
            display: block;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-align: center;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9em;
        }
        
        .control-group input, .control-group select, .control-group button {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
        
        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .summary-title {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-stat {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        
        .summary-stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-stat-label {
            font-size: 1em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            margin-top: 5px;
            font-weight: 600;
        }
        
        .trend-up {
            color: #27ae60;
        }
        
        .trend-down {
            color: #e74c3c;
        }
        
        .trend-arrow {
            font-size: 1.2em;
        }
        
        .comparison-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        
        .comparison-title {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .comparison-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .comparison-item {
            text-align: center;
        }
        
        .comparison-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .comparison-label {
            font-size: 0.8em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .account-comparison {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .account-comparison h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .stat-with-trend {
            position: relative;
        }
        
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .account-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .account-card:hover {
            transform: translateY(-5px);
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .account-name {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .account-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .payment-methods {
            margin-top: 20px;
        }
        
        .payment-methods h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .payment-method {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .payment-method:last-child {
            margin-bottom: 0;
        }
        
        .payment-info {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .payment-details {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .payment-amount {
            font-weight: 700;
            color: #27ae60;
            font-size: 1.3em;
            text-align: right;
        }
        
        .payment-percent {
            font-size: 0.9em;
            color: #6c757d;
            text-align: right;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #f5c6cb;
        }
        
        .last-updated {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-cancel {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-cancel:hover {
            background: #d0d0d0;
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            font-size: 0.8em;
            padding: 8px 12px;
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            font-size: 0.8em;
            padding: 8px 12px;
        }
        
        .accounts-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .account-item:last-child {
            margin-bottom: 0;
        }
        
        .account-info {
            flex: 1;
        }
        
        .account-item-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
            margin-bottom: 3px;
        }
        
        .account-item-details {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .account-actions {
            display: flex;
            gap: 8px;
        }
        
        #currentAccountsList h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        #accountForm h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .accounts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .account-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .account-actions {
                align-self: flex-end;
            }
            
            .comparison-stats {
                grid-template-columns: 1fr;
            }
        }
        
        /* Enhanced Responsive Design */
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .dashboard {
                padding: 0;
            }
            
            .header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            
            .header p {
                font-size: 0.9em !important;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .control-group {
                width: 100%;
            }
            
            .control-group input, 
            .control-group select, 
            .control-group button {
                width: 100%;
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.9em;
            }
            
            .logout-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.8em;
            }
            
            .summary-section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .summary-title {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-stat {
                padding: 20px 15px;
            }
            
            .summary-stat-value {
                font-size: 2em;
            }
            
            .accounts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .account-card {
                padding: 20px 15px;
                margin-bottom: 0;
            }
            
            .account-name {
                font-size: 1.2em;
                line-height: 1.3;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.6em;
            }
            
            .payment-method {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .payment-amount {
                font-size: 1.2em;
            }
            
            .comparison-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .trend-indicator {
                font-size: 0.7em;
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
                padding: 20px 15px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .accounts-list {
                max-height: 200px;
            }
            
            .account-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .account-actions {
                align-self: stretch;
                justify-content: space-between;
            }
            
            .form-group textarea {
                height: 80px;
                font-size: 14px;
            }
            
            .form-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-buttons button {
                width: 100%;
            }
            
            .auth-container {
                width: 95%;
                padding: 30px 20px;
            }
            
            .auth-title {
                font-size: 1.8em;
            }
            
            .pin-input {
                font-size: 1.1em;
                padding: 12px 16px;
            }
        }
        
        /* Medium mobile devices and small tablets */
        @media (min-width: 481px) and (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .header {
                padding: 25px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .control-group {
                width: 100%;
            }
            
            .control-group input, 
            .control-group select, 
            .control-group button {
                width: 100%;
                padding: 12px;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .accounts-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .account-card {
                padding: 25px 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .comparison-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .modal-content {
                width: 90%;
                margin: 5% auto;
                padding: 25px 20px;
            }
            
            .account-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .account-actions {
                align-self: stretch;
                justify-content: flex-end;
            }
        }
        
        /* Large tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            body {
                padding: 20px;
            }
            
            .header {
                padding: 30px 25px;
            }
            
            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
            }
            
            .control-group {
                min-width: 200px;
                flex: 1;
                max-width: 250px;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .accounts-grid {
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 25px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal-content {
                width: 80%;
                max-width: 600px;
            }
        }
        
        /* Desktop and larger screens */
        @media (min-width: 1025px) {
            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .control-group {
                min-width: 180px;
                flex: 0 0 auto;
            }
            
            .summary-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .accounts-grid {
                grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Extra large screens */
        @media (min-width: 1400px) {
            .dashboard {
                max-width: 1600px;
            }
            
            .accounts-grid {
                grid-template-columns: repeat(auto-fit, minmax(650px, 1fr));
            }
        }
        
        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal-content {
                max-height: 80vh;
                overflow-y: auto;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn, .auth-btn {
                border: none;
                outline: none;
            }
        }
        
        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus improvements for keyboard navigation */
        .btn:focus, .auth-btn:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* Improved touch targets for mobile */
        @media (max-width: 768px) {
            .btn, .auth-btn, input, select, textarea {
                min-height: 44px; /* Apple's recommended minimum touch target */
                min-width: 44px;
            }
            
            .close {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .logout-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-overlay" id="authOverlay" style="display: none;">
        <div class="auth-container">
            <h2 class="auth-title">PIN Authentication</h2>
            <p class="auth-subtitle">Please enter your PIN to access the dashboard.</p>
            <input type="password" class="pin-input" id="pinInput" placeholder="Enter PIN">
            <button class="auth-btn" id="authBtn">Authenticate</button>
            <div class="error-message" id="authErrorMessage"></div>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <button class="logout-btn" id="logoutBtn" onclick="logout()">🔓 Logout</button>
        <div class="header">
            <h1>🍔 OlaClick Multi-Account Dashboard</h1>
            <p style="text-align: center; color: #6c757d; margin-bottom: 20px; font-size: 1.1em;">
                📊 Real-time data with 7-day comparison trends
            </p>
            <div class="controls">
                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="control-group">
                    <label>Timezone</label>
                    <select id="timezone">
                        <option value="America/Lima">Lima (America/Lima)</option>
                        <option value="America/New_York">New York (America/New_York)</option>
                        <option value="America/Mexico_City">Mexico City (America/Mexico_City)</option>
                        <option value="America/Bogota">Bogotá (America/Bogota)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-refresh" onclick="refreshData()">🔄 Refresh Data</button>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="showAccountModal()">⚙️ Manage Accounts</button>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div>🔄 Loading data from all accounts...</div>
        </div>
        
        <div id="summarySection" class="summary-section" style="display: none;">
            <h2 class="summary-title">📊 Combined Summary</h2>
            <div id="summaryStats" class="summary-stats"></div>
            <div class="payment-methods">
                <h3>💳 Aggregated Payment Methods</h3>
                <div id="summaryPaymentMethods"></div>
            </div>
        </div>
        
        <div id="accountsContainer" class="accounts-grid"></div>
        
        <div id="lastUpdated" class="last-updated"></div>
    </div>

    <!-- Account Management Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAccountModal()">&times;</span>
            <h2>Manage Accounts</h2>
            
            <!-- Current Accounts List -->
            <div id="currentAccountsList">
                <h3>Current Accounts</h3>
                <div id="accountsList" class="accounts-list"></div>
            </div>
            
            <!-- Add/Edit Account Form -->
            <div id="accountForm">
                <h3 id="formTitle">Add New Account</h3>
                <div class="form-group">
                    <label>Company Token</label>
                    <input type="text" id="companyToken" placeholder="e.g., blast-smash-burgers">
                    <small style="color: #6c757d; font-size: 0.8em;">
                        This serves as the unique identifier for the account
                    </small>
                </div>
                <div class="form-group">
                    <label>Account Name</label>
                    <input type="text" id="accountName" placeholder="e.g., Blast Smash Burgers">
                </div>
                <div class="form-group">
                    <label>Authentication Tokens (JSON Format)</label>
                    <textarea id="tokensValue" placeholder='[{"company_token":"your-company-token","auth_token":"your-auth-token"}]' rows="4"></textarea>
                    <small style="color: #6c757d; font-size: 0.8em;">
                        Enter tokens as JSON array. You can also paste a legacy cookie string and it will be automatically converted.
                    </small>
                </div>
                <div class="form-group">
                    <label>Additional Cookies (Optional)</label>
                    <input type="text" id="additionalCookies" placeholder="e.g., ajs_user_id=...; ajs_anonymous_id=...">
                    <small style="color: #6c757d; font-size: 0.8em;">
                        Additional cookie parameters (without the tokens parameter)
                    </small>
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="saveAccount()">💾 Save Account</button>
                    <button class="btn btn-cancel" onclick="clearForm()" id="cancelBtn" style="display: none;">Cancel Edit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to get today's date in Lima timezone
        function getTodayInLima() {
            const now = new Date();
            // Convert to Lima timezone and format as YYYY-MM-DD
            return now.toLocaleDateString('en-CA', { timeZone: 'America/Lima' });
        }
        
        // Helper function to get date in specific timezone
        function getDateInTimezone(timezone) {
            const now = new Date();
            return now.toLocaleDateString('en-CA', { timeZone: timezone });
        }
        
        // Set default dates to today in Lima timezone
        const todayInLima = getTodayInLima();
        document.getElementById('startDate').value = todayInLima;
        document.getElementById('endDate').value = todayInLima;
        
        // Debug: Show current timezone info
        console.log('🕐 Timezone Debug Info:');
        console.log(`   Browser timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`);
        console.log(`   Lima date: ${todayInLima}`);
        console.log(`   UTC date: ${new Date().toISOString().split('T')[0]}`);
        console.log(`   Browser local date: ${new Date().toLocaleDateString('en-CA')}`);
        
        let accounts = [];
        let lastData = null;
        let isEditing = false;
        let editingCompanyToken = null;
        
        // Load initial data
        loadAccounts();
        refreshData();
        
        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
        
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                accounts = data.accounts || [];
                displayAccountsList();
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }
        
        function displayAccountsList() {
            const accountsList = document.getElementById('accountsList');
            
            accountsList.innerHTML = accounts.map(account => {
                let tokenDisplay = 'N/A';
                if (account.tokens && Array.isArray(account.tokens)) {
                    tokenDisplay = `${account.tokens.length} token(s)`;
                } else if (account.cookie) {
                    tokenDisplay = account.cookie.substring(0, 50) + '...';
                }
                
                return `
                    <div class="account-item">
                        <div class="account-info">
                            <div class="account-item-name">${account.name}</div>
                            <div class="account-item-details">
                                <div><strong>Company Token:</strong> ${account.company_token}</div>
                                <div><strong>Auth Tokens:</strong> ${tokenDisplay}</div>
                                ${account.additional_cookies ? `<div><strong>Additional Cookies:</strong> ${account.additional_cookies.substring(0, 50)}...</div>` : ''}
                            </div>
                        </div>
                        <div class="account-actions">
                            <button class="btn btn-edit" onclick="editAccount('${account.company_token}')">✏️ Edit</button>
                            <button class="btn btn-delete" onclick="deleteAccount('${account.company_token}')">🗑️ Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function editAccount(companyToken) {
            try {
                const response = await fetch(`/api/accounts/${companyToken}`);
                const data = await response.json();
                
                if (data.success) {
                    isEditing = true;
                    editingCompanyToken = companyToken;
                    
                    document.getElementById('formTitle').textContent = 'Edit Account';
                    document.getElementById('companyToken').value = data.account.company_token;
                    document.getElementById('companyToken').readOnly = true;
                    document.getElementById('accountName').value = data.account.name;
                    
                    // Handle tokens - either new format or legacy cookie
                    if (data.account.tokens && Array.isArray(data.account.tokens)) {
                        document.getElementById('tokensValue').value = JSON.stringify(data.account.tokens, null, 2);
                        document.getElementById('additionalCookies').value = data.account.additional_cookies || '';
                    } else if (data.account.cookie) {
                        // Legacy cookie format - show it for migration
                        document.getElementById('tokensValue').value = data.account.cookie;
                        document.getElementById('additionalCookies').value = '';
                    }
                    
                    document.getElementById('cancelBtn').style.display = 'inline-block';
                    
                    // Scroll to form
                    document.getElementById('accountForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Error loading account: ' + data.error);
                }
            } catch (error) {
                alert('Error loading account: ' + error.message);
            }
        }
        
        async function deleteAccount(companyToken) {
            if (!confirm(`Are you sure you want to delete account "${companyToken}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${companyToken}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Account deleted successfully!');
                    await loadAccounts();
                    refreshData();
                } else {
                    alert('Error deleting account: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting account: ' + error.message);
            }
        }
        
        function clearForm() {
            isEditing = false;
            editingCompanyToken = null;
            
            document.getElementById('formTitle').textContent = 'Add New Account';
            document.getElementById('companyToken').value = '';
            document.getElementById('companyToken').readOnly = false;
            document.getElementById('accountName').value = '';
            document.getElementById('tokensValue').value = '';
            document.getElementById('additionalCookies').value = '';
            document.getElementById('cancelBtn').style.display = 'none';
        }
        
        // Helper function to detect if input is a legacy cookie string
        function isLegacyCookieString(input) {
            return input.includes('tokens=') && input.includes('%');
        }
        
        // Helper function to validate JSON tokens
        function validateTokens(tokensString) {
            try {
                const tokens = JSON.parse(tokensString);
                if (!Array.isArray(tokens)) {
                    throw new Error('Tokens must be an array');
                }
                
                for (const token of tokens) {
                    if (!token.company_token || !token.auth_token) {
                        throw new Error('Each token must have company_token and auth_token');
                    }
                }
                
                return tokens;
            } catch (error) {
                throw new Error('Invalid tokens format: ' + error.message);
            }
        }
        
        async function refreshData() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('accountsContainer');
            const summarySection = document.getElementById('summarySection');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            summarySection.style.display = 'none';
            
            try {
                // Build URL parameters correctly
                const params = new URLSearchParams();
                params.append('filter[start_date]', document.getElementById('startDate').value);
                params.append('filter[end_date]', document.getElementById('endDate').value);
                params.append('filter[timezone]', document.getElementById('timezone').value);
                
                console.log('📤 Sending parameters:', params.toString());
                
                const response = await fetch(`/api/orders/all?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    lastData = data;
                    displaySummary(data.aggregated, data.comparison, data.periods);
                    displayData(data.accounts);
                    updateLastUpdated(data.timestamp);
                } else {
                    throw new Error(data.error || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
                container.style.display = 'grid';
                if (lastData && lastData.aggregated) {
                    summarySection.style.display = 'block';
                }
            }
        }
        
        function displaySummary(aggregatedData, comparisonData, periods) {
            const summaryStats = document.getElementById('summaryStats');
            const summaryPaymentMethods = document.getElementById('summaryPaymentMethods');
            
            // Helper function to create trend indicator
            function createTrendIndicator(comparison, type) {
                const data = comparison[type];
                const trendClass = data.trend === 'up' ? 'trend-up' : 'trend-down';
                const arrow = data.trend === 'up' ? '↗' : '↘';
                const sign = data.difference >= 0 ? '+' : '';
                
                // Format the difference value properly
                let formattedDifference;
                if (type === 'amount') {
                    formattedDifference = `S/ ${Math.abs(data.difference).toFixed(2)}`;
                } else {
                    formattedDifference = Math.abs(data.difference).toString();
                }
                
                return `
                    <div class="trend-indicator ${trendClass}">
                        <span class="trend-arrow">${arrow}</span>
                        <span>${sign}${formattedDifference} (${data.percentChange.toFixed(1)}%)</span>
                    </div>
                `;
            }
            
            // Display summary statistics with trends
            summaryStats.innerHTML = `
                <div class="summary-stat">
                    <div class="summary-stat-value">${aggregatedData.totalOrders}</div>
                    <div class="summary-stat-label">Total Orders</div>
                    ${comparisonData ? createTrendIndicator(comparisonData, 'orders') : ''}
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">S/ ${aggregatedData.totalAmount.toFixed(2)}</div>
                    <div class="summary-stat-label">Total Amount</div>
                    ${comparisonData ? createTrendIndicator(comparisonData, 'amount') : ''}
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${aggregatedData.paymentMethods.length}</div>
                    <div class="summary-stat-label">Payment Methods</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${aggregatedData.accountsCount}</div>
                    <div class="summary-stat-label">Active Accounts</div>
                </div>
            `;
            
            // Add comparison section if data is available
            if (comparisonData && periods) {
                // Remove any existing comparison sections
                const existingComparison = document.querySelector('.comparison-section');
                if (existingComparison) {
                    existingComparison.remove();
                }
                
                summaryStats.insertAdjacentHTML('afterend', `
                    <div class="comparison-section">
                        <div class="comparison-title">📊 Comparison with ${periods.previous.start} to ${periods.previous.end}</div>
                        <div class="comparison-stats">
                            <div class="comparison-item">
                                <div class="comparison-value ${comparisonData.orders.trend === 'up' ? 'trend-up' : 'trend-down'}">
                                    ${comparisonData.orders.trend === 'up' ? '↗' : '↘'} ${Math.abs(comparisonData.orders.difference)}
                                </div>
                                <div class="comparison-label">Orders Change</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-value ${comparisonData.amount.trend === 'up' ? 'trend-up' : 'trend-down'}">
                                    ${comparisonData.amount.trend === 'up' ? '↗' : '↘'} S/ ${Math.abs(comparisonData.amount.difference).toFixed(2)}
                                </div>
                                <div class="comparison-label">Amount Change</div>
                            </div>
                        </div>
                    </div>
                `);
            }
            
            // Display aggregated payment methods
            summaryPaymentMethods.innerHTML = aggregatedData.paymentMethods.map(method => `
                <div class="payment-method">
                    <div class="payment-info">
                        <div class="payment-name">${method.name}</div>
                        <div class="payment-details">${method.count} orders</div>
                    </div>
                    <div>
                        <div class="payment-amount">S/ ${method.sum.toFixed(2)}</div>
                        <div class="payment-percent">${method.percent.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');
        }
        
        function displayData(accountsData) {
            const container = document.getElementById('accountsContainer');
            
            container.innerHTML = accountsData.map(account => {
                if (!account.success) {
                    return `
                        <div class="account-card">
                            <div class="account-header">
                                <div class="account-name">${account.account}</div>
                                <div class="account-status status-error">Error</div>
                            </div>
                            <div class="error-message">
                                ${typeof account.error === 'string' ? account.error : JSON.stringify(account.error)}
                            </div>
                        </div>
                    `;
                }
                
                const data = account.data;
                let totalOrders = 0;
                let totalAmount = 0;
                
                // Calculate totals from the data array
                if (data && data.data) {
                    data.data.forEach(paymentMethod => {
                        totalOrders += paymentMethod.count || 0;
                        totalAmount += paymentMethod.sum || 0;
                    });
                }
                
                // Helper function to create account trend indicator
                function createAccountTrendIndicator(comparison, type) {
                    if (!comparison) return '';
                    
                    const data = comparison[type];
                    const trendClass = data.trend === 'up' ? 'trend-up' : 'trend-down';
                    const arrow = data.trend === 'up' ? '↗' : '↘';
                    const sign = data.difference >= 0 ? '+' : '';
                    
                    // Format the difference value properly
                    let formattedDifference;
                    if (type === 'amount') {
                        formattedDifference = `S/ ${Math.abs(data.difference).toFixed(2)}`;
                    } else {
                        formattedDifference = Math.abs(data.difference).toString();
                    }
                    
                    return `
                        <div class="trend-indicator ${trendClass}">
                            <span class="trend-arrow">${arrow}</span>
                            <span>${sign}${formattedDifference} (${data.percentChange.toFixed(1)}%)</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="account-card">
                        <div class="account-header">
                            <div class="account-name">${account.account}</div>
                            <div class="account-status status-success">Active</div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card stat-with-trend">
                                <div class="stat-value">${totalOrders}</div>
                                <div class="stat-label">Orders</div>
                                ${createAccountTrendIndicator(account.comparison, 'orders')}
                            </div>
                            <div class="stat-card stat-with-trend">
                                <div class="stat-value">S/ ${totalAmount.toFixed(2)}</div>
                                <div class="stat-label">Total</div>
                                ${createAccountTrendIndicator(account.comparison, 'amount')}
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data?.data?.length || 0}</div>
                                <div class="stat-label">Payment Methods</div>
                            </div>
                        </div>
                        
                        ${account.comparison ? `
                            <div class="account-comparison">
                                <h4>📈 7-Day Comparison</h4>
                                <div class="comparison-stats">
                                    <div class="comparison-item">
                                        <div class="comparison-value ${account.comparison.orders.trend === 'up' ? 'trend-up' : 'trend-down'}">
                                            ${account.comparison.orders.trend === 'up' ? '↗' : '↘'} ${Math.abs(account.comparison.orders.difference)}
                                        </div>
                                        <div class="comparison-label">Orders vs Previous Week</div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-value ${account.comparison.amount.trend === 'up' ? 'trend-up' : 'trend-down'}">
                                            ${account.comparison.amount.trend === 'up' ? '↗' : '↘'} S/ ${Math.abs(account.comparison.amount.difference).toFixed(2)}
                                        </div>
                                        <div class="comparison-label">Amount vs Previous Week</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="payment-methods">
                            <h3>💳 Payment Methods</h3>
                            ${(data?.data || []).map(paymentMethod => `
                                <div class="payment-method">
                                    <div class="payment-info">
                                        <div class="payment-name">${paymentMethod.name}</div>
                                        <div class="payment-details">${paymentMethod.count} orders</div>
                                    </div>
                                    <div>
                                        <div class="payment-amount">S/ ${paymentMethod.sum.toFixed(2)}</div>
                                        <div class="payment-percent">${paymentMethod.percent.toFixed(1)}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateLastUpdated(timestamp) {
            const element = document.getElementById('lastUpdated');
            if (timestamp) {
                const date = new Date(timestamp);
                element.textContent = `Last updated: ${date.toLocaleString()}`;
            }
        }
        
        function showAccountModal() {
            document.getElementById('accountModal').style.display = 'block';
            loadAccounts(); // Refresh accounts list when modal opens
        }
        
        function closeAccountModal() {
            document.getElementById('accountModal').style.display = 'none';
            clearForm();
        }
        
        async function saveAccount() {
            const companyToken = document.getElementById('companyToken').value;
            const accountName = document.getElementById('accountName').value;
            const tokensValue = document.getElementById('tokensValue').value;
            const additionalCookies = document.getElementById('additionalCookies').value;
            
            if (!companyToken || !accountName || !tokensValue) {
                alert('Please fill in all required fields');
                return;
            }
            
            let requestBody;
            
            try {
                // Check if it's a legacy cookie string
                if (isLegacyCookieString(tokensValue)) {
                    // Send legacy cookie for server-side migration
                    requestBody = {
                        name: accountName,
                        cookie: tokensValue
                    };
                } else {
                    // Validate and send tokens
                    const tokens = validateTokens(tokensValue);
                    requestBody = {
                        name: accountName,
                        tokens: tokens,
                        additional_cookies: additionalCookies
                    };
                }
            } catch (error) {
                alert('Error validating tokens: ' + error.message);
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${editingCompanyToken || companyToken}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(isEditing ? 'Account updated successfully!' : 'Account saved successfully!');
                    clearForm();
                    await loadAccounts();
                    refreshData();
                } else {
                    alert('Error saving account: ' + result.error);
                }
            } catch (error) {
                alert('Error saving account: ' + error.message);
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('accountModal');
            if (event.target === modal) {
                closeAccountModal();
            }
        }
        
        // ====== AUTHENTICATION SYSTEM ======
        const CORRECT_PIN = '105646';
        const AUTH_KEY = 'dashboard_authenticated';
        
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });
        
        function checkAuthentication() {
            const isAuthenticated = localStorage.getItem(AUTH_KEY) === 'true';
            
            if (isAuthenticated) {
                showDashboard();
            } else {
                showAuthOverlay();
            }
        }
        
        function showAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('authenticated');
            document.getElementById('pinInput').focus();
            
            // Add event listeners
            const pinInput = document.getElementById('pinInput');
            const authBtn = document.getElementById('authBtn');
            
            // Handle Enter key
            pinInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticate();
                }
            });
            
            // Handle auth button click
            authBtn.addEventListener('click', authenticate);
        }
        
        function showDashboard() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('dashboard').classList.add('authenticated');
        }
        
        function authenticate() {
            const pinInput = document.getElementById('pinInput');
            const authBtn = document.getElementById('authBtn');
            const errorMessage = document.getElementById('authErrorMessage');
            const enteredPin = pinInput.value;
            
            // Disable button during authentication
            authBtn.disabled = true;
            authBtn.textContent = 'Authenticating...';
            
            // Simulate slight delay for better UX
            setTimeout(() => {
                if (enteredPin === CORRECT_PIN) {
                    // Successful authentication
                    localStorage.setItem(AUTH_KEY, 'true');
                    showDashboard();
                    pinInput.value = '';
                    errorMessage.style.display = 'none';
                    pinInput.classList.remove('error');
                } else {
                    // Failed authentication
                    errorMessage.textContent = 'Incorrect PIN. Please try again.';
                    errorMessage.style.display = 'block';
                    pinInput.classList.add('error');
                    pinInput.value = '';
                    pinInput.focus();
                    
                    // Remove error styling after animation
                    setTimeout(() => {
                        pinInput.classList.remove('error');
                    }, 500);
                }
                
                // Re-enable button
                authBtn.disabled = false;
                authBtn.textContent = 'Authenticate';
            }, 300);
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem(AUTH_KEY);
                document.getElementById('pinInput').value = '';
                showAuthOverlay();
            }
        }
        
        // Prevent right-click context menu for additional security
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // Prevent F12 and other developer shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html> 